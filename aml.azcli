RESOURCE_GROUP='OpenAI-Demo'
VNET_NAME='vnet-1'
AML_SUBNET_NAME='AML-Subnet'
PV_SUBNET_NAME='PrivateLink-Subnet'
KEYVAULT_NAME=$(az keyvault list --resource-group $RESOURCE_GROUP --query [0].name -o tsv)
ACR_NAME="$(az acr list --resource-group $RESOURCE_GROUP --query [0].name -o tsv)"
LOCATION=eastus
IDENTITY_NAME='aml-identity'

# az ml workspace create --workspace-name myWorkspace --resource-group $RESOURCE_GROUP --managed-network $VNET_NAME --public-network-access Disabled --enable-data-isolation true --key-vault $KEYVAULT_NAME --container-registry $ACR_NAME
az ml workspace create --workspace-name myWorkspace --resource-group $RESOURCE_GROUP

az network private-endpoint create --name aml-privateEndpoint --resource-group $RESOURCE_GROUP --vnet-name $VNET_NAME --subnet $PV_SUBNET_NAME --private-connection-resource-id $ (az ml workspace show --name myWorkspace--resource-group $RESOURCE_GROUP --query id --output tsv) --group-id workspace
az network private-dns zone create --name privatelink.api.azureml.ms --resource-group $RESOURCE_GROUP
az network private-dns link vnet create --name aml-privateDnsLink --resource-group $RESOURCE_GROUP --virtual-network $VNET_NAME --zone-name privatelink.api.azureml.ms --registration-enabled false
az network private-dns record-set a create --name myWorkspace--zone-name privatelink.api.azureml.ms --resource-group $RESOURCE_GROUP
az network private-dns record-set a add-record --record-set-name myWorkspace--zone-name privatelink.api.azureml.ms --resource-group $RESOURCE_GROUP --ipv4-address $ (az network private-endpoint show --name aml-privateEndpoint --resource-group $RESOURCE_GROUP --query "customDnsConfigs[0].ipAddresses[0]" --output tsv)

# az ml workspace identity assign --workspace-name myWorkspace --resource-group $RESOURCE_GROUP
az identity create --name $IDENTITY_NAME --resource-group $RESOURCE_GROUP --location $LOCATION
az ml workspace identity assign --workspace-name myWorkspace --resource-group $RESOURCE_GROUP --identities $IDENTITY_NAME

